{"dependencies":[{"name":"../Utilities/infoLog","data":{"asyncType":null,"locs":[{"start":{"line":13,"column":16,"index":253},"end":{"line":13,"column":47,"index":284}}],"key":"te7FMDljSHoh4Ptoq0ebhkaWbSA="}},{"name":"invariant","data":{"asyncType":null,"locs":[{"start":{"line":14,"column":18,"index":304},"end":{"line":14,"column":38,"index":324}}],"key":"Fzi/BpZws2YooIGJ9b6u0HJtuks="}}],"output":[{"data":{"code":"__d(function (global, require, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  /**\n   * Copyright (c) Meta Platforms, Inc. and affiliates.\n   *\n   * This source code is licensed under the MIT license found in the\n   * LICENSE file in the root directory of this source tree.\n   *\n   * @format\n   * \n   */\n\n  'use strict';\n\n  const infoLog = require(_dependencyMap[0], \"../Utilities/infoLog\");\n  const invariant = require(_dependencyMap[1], \"invariant\");\n  const DEBUG = false;\n\n  /**\n   * TaskQueue - A system for queueing and executing a mix of simple callbacks and\n   * trees of dependent tasks based on Promises. No tasks are executed unless\n   * `processNext` is called.\n   *\n   * `enqueue` takes a Task object with either a simple `run` callback, or a\n   * `gen` function that returns a `Promise` and puts it in the queue.  If a gen\n   * function is supplied, then the promise it returns will block execution of\n   * tasks already in the queue until it resolves. This can be used to make sure\n   * the first task is fully resolved (including asynchronous dependencies that\n   * also schedule more tasks via `enqueue`) before starting on the next task.\n   * The `onMoreTasks` constructor argument is used to inform the owner that an\n   * async task has resolved and that the queue should be processed again.\n   *\n   * Note: Tasks are only actually executed with explicit calls to `processNext`.\n   */\n  class TaskQueue {\n    /**\n     * TaskQueue instances are self contained and independent, so multiple tasks\n     * of varying semantics and priority can operate together.\n     *\n     * `onMoreTasks` is invoked when `PromiseTask`s resolve if there are more\n     * tasks to process.\n     */\n    constructor({\n      onMoreTasks\n    }) {\n      this._onMoreTasks = onMoreTasks;\n      this._queueStack = [{\n        tasks: [],\n        popable: false\n      }];\n    }\n\n    /**\n     * Add a task to the queue.  It is recommended to name your tasks for easier\n     * async debugging. Tasks will not be executed until `processNext` is called\n     * explicitly.\n     */\n    enqueue(task) {\n      this._getCurrentQueue().push(task);\n    }\n    enqueueTasks(tasks) {\n      tasks.forEach(task => this.enqueue(task));\n    }\n    cancelTasks(tasksToCancel) {\n      // search through all tasks and remove them.\n      this._queueStack = this._queueStack.map(queue => ({\n        ...queue,\n        tasks: queue.tasks.filter(task => tasksToCancel.indexOf(task) === -1)\n      })).filter((queue, idx) => queue.tasks.length > 0 || idx === 0);\n    }\n\n    /**\n     * Check to see if `processNext` should be called.\n     *\n     * @returns {boolean} Returns true if there are tasks that are ready to be\n     * processed with `processNext`, or returns false if there are no more tasks\n     * to be processed right now, although there may be tasks in the queue that\n     * are blocked by earlier `PromiseTask`s that haven't resolved yet.\n     * `onMoreTasks` will be called after each `PromiseTask` resolves if there are\n     * tasks ready to run at that point.\n     */\n    hasTasksToProcess() {\n      return this._getCurrentQueue().length > 0;\n    }\n\n    /**\n     * Executes the next task in the queue.\n     */\n    processNext() {\n      const queue = this._getCurrentQueue();\n      if (queue.length) {\n        const task = queue.shift();\n        try {\n          if (typeof task === 'object' && task.gen) {\n            DEBUG && infoLog('TaskQueue: genPromise for task ' + task.name);\n            this._genPromise(task);\n          } else if (typeof task === 'object' && task.run) {\n            DEBUG && infoLog('TaskQueue: run task ' + task.name);\n            task.run();\n          } else {\n            invariant(typeof task === 'function', 'Expected Function, SimpleTask, or PromiseTask, but got:\\n' + JSON.stringify(task, null, 2));\n            DEBUG && infoLog('TaskQueue: run anonymous task');\n            task();\n          }\n        } catch (e) {\n          e.message = 'TaskQueue: Error with task ' + (task.name || '') + ': ' + e.message;\n          throw e;\n        }\n      }\n    }\n    _getCurrentQueue() {\n      const stackIdx = this._queueStack.length - 1;\n      const queue = this._queueStack[stackIdx];\n      if (queue.popable && queue.tasks.length === 0 && this._queueStack.length > 1) {\n        this._queueStack.pop();\n        DEBUG && infoLog('TaskQueue: popped queue: ', {\n          stackIdx,\n          queueStackSize: this._queueStack.length\n        });\n        return this._getCurrentQueue();\n      } else {\n        return queue.tasks;\n      }\n    }\n    _genPromise(task) {\n      // Each async task pushes it's own queue onto the queue stack. This\n      // effectively defers execution of previously queued tasks until the promise\n      // resolves, at which point we allow the new queue to be popped, which\n      // happens once it is fully processed.\n      this._queueStack.push({\n        tasks: [],\n        popable: false\n      });\n      const stackIdx = this._queueStack.length - 1;\n      const stackItem = this._queueStack[stackIdx];\n      DEBUG && infoLog('TaskQueue: push new queue: ', {\n        stackIdx\n      });\n      DEBUG && infoLog('TaskQueue: exec gen task ' + task.name);\n      task.gen().then(() => {\n        DEBUG && infoLog('TaskQueue: onThen for gen task ' + task.name, {\n          stackIdx,\n          queueStackSize: this._queueStack.length\n        });\n        stackItem.popable = true;\n        this.hasTasksToProcess() && this._onMoreTasks();\n      }).catch(ex => {\n        setTimeout(() => {\n          ex.message = `TaskQueue: Error resolving Promise in task ${task.name}: ${ex.message}`;\n          throw ex;\n        }, 0);\n      });\n    }\n  }\n  module.exports = TaskQueue;\n});","lineCount":155,"map":[[2,2,1,0],[3,0,2,0],[4,0,3,0],[5,0,4,0],[6,0,5,0],[7,0,6,0],[8,0,7,0],[9,0,8,0],[10,0,9,0],[12,2,11,0],[12,14,11,12],[14,2,13,0],[14,8,13,6,"infoLog"],[14,15,13,13],[14,18,13,16,"require"],[14,25,13,23],[14,26,13,23,"_dependencyMap"],[14,40,13,23],[14,67,13,46],[14,68,13,47],[15,2,14,0],[15,8,14,6,"invariant"],[15,17,14,15],[15,20,14,18,"require"],[15,27,14,25],[15,28,14,25,"_dependencyMap"],[15,42,14,25],[15,58,14,37],[15,59,14,38],[16,2,26,0],[16,8,26,6,"DEBUG"],[16,13,26,18],[16,16,26,21],[16,21,26,26],[18,2,28,0],[19,0,29,0],[20,0,30,0],[21,0,31,0],[22,0,32,0],[23,0,33,0],[24,0,34,0],[25,0,35,0],[26,0,36,0],[27,0,37,0],[28,0,38,0],[29,0,39,0],[30,0,40,0],[31,0,41,0],[32,0,42,0],[33,0,43,0],[34,2,44,0],[34,8,44,6,"TaskQueue"],[34,17,44,15],[34,18,44,16],[35,4,45,2],[36,0,46,0],[37,0,47,0],[38,0,48,0],[39,0,49,0],[40,0,50,0],[41,0,51,0],[42,4,52,2,"constructor"],[42,15,52,13,"constructor"],[42,16,52,14],[43,6,52,15,"onMoreTasks"],[44,4,52,58],[44,5,52,59],[44,7,52,61],[45,6,53,4],[45,10,53,8],[45,11,53,9,"_onMoreTasks"],[45,23,53,21],[45,26,53,24,"onMoreTasks"],[45,37,53,35],[46,6,54,4],[46,10,54,8],[46,11,54,9,"_queueStack"],[46,22,54,20],[46,25,54,23],[46,26,54,24],[47,8,54,25,"tasks"],[47,13,54,30],[47,15,54,32],[47,17,54,34],[48,8,54,36,"popable"],[48,15,54,43],[48,17,54,45],[49,6,54,50],[49,7,54,51],[49,8,54,52],[50,4,55,2],[52,4,57,2],[53,0,58,0],[54,0,59,0],[55,0,60,0],[56,0,61,0],[57,4,62,2,"enqueue"],[57,11,62,9,"enqueue"],[57,12,62,10,"task"],[57,16,62,20],[57,18,62,28],[58,6,63,4],[58,10,63,8],[58,11,63,9,"_getCurrentQueue"],[58,27,63,25],[58,28,63,26],[58,29,63,27],[58,30,63,28,"push"],[58,34,63,32],[58,35,63,33,"task"],[58,39,63,37],[58,40,63,38],[59,4,64,2],[60,4,66,2,"enqueueTasks"],[60,16,66,14,"enqueueTasks"],[60,17,66,15,"tasks"],[60,22,66,33],[60,24,66,41],[61,6,67,4,"tasks"],[61,11,67,9],[61,12,67,10,"forEach"],[61,19,67,17],[61,20,67,18,"task"],[61,24,67,22],[61,28,67,26],[61,32,67,30],[61,33,67,31,"enqueue"],[61,40,67,38],[61,41,67,39,"task"],[61,45,67,43],[61,46,67,44],[61,47,67,45],[62,4,68,2],[63,4,70,2,"cancelTasks"],[63,15,70,13,"cancelTasks"],[63,16,70,14,"tasksToCancel"],[63,29,70,40],[63,31,70,48],[64,6,71,4],[65,6,72,4],[65,10,72,8],[65,11,72,9,"_queueStack"],[65,22,72,20],[65,25,72,23],[65,29,72,27],[65,30,72,28,"_queueStack"],[65,41,72,39],[65,42,73,7,"map"],[65,45,73,10],[65,46,73,11,"queue"],[65,51,73,16],[65,56,73,21],[66,8,74,8],[66,11,74,11,"queue"],[66,16,74,16],[67,8,75,8,"tasks"],[67,13,75,13],[67,15,75,15,"queue"],[67,20,75,20],[67,21,75,21,"tasks"],[67,26,75,26],[67,27,75,27,"filter"],[67,33,75,33],[67,34,75,34,"task"],[67,38,75,38],[67,42,75,42,"tasksToCancel"],[67,55,75,55],[67,56,75,56,"indexOf"],[67,63,75,63],[67,64,75,64,"task"],[67,68,75,68],[67,69,75,69],[67,74,75,74],[67,75,75,75],[67,76,75,76],[68,6,76,6],[68,7,76,7],[68,8,76,8],[68,9,76,9],[68,10,77,7,"filter"],[68,16,77,13],[68,17,77,14],[68,18,77,15,"queue"],[68,23,77,20],[68,25,77,22,"idx"],[68,28,77,25],[68,33,77,30,"queue"],[68,38,77,35],[68,39,77,36,"tasks"],[68,44,77,41],[68,45,77,42,"length"],[68,51,77,48],[68,54,77,51],[68,55,77,52],[68,59,77,56,"idx"],[68,62,77,59],[68,67,77,64],[68,68,77,65],[68,69,77,66],[69,4,78,2],[71,4,80,2],[72,0,81,0],[73,0,82,0],[74,0,83,0],[75,0,84,0],[76,0,85,0],[77,0,86,0],[78,0,87,0],[79,0,88,0],[80,0,89,0],[81,4,90,2,"hasTasksToProcess"],[81,21,90,19,"hasTasksToProcess"],[81,22,90,19],[81,24,90,31],[82,6,91,4],[82,13,91,11],[82,17,91,15],[82,18,91,16,"_getCurrentQueue"],[82,34,91,32],[82,35,91,33],[82,36,91,34],[82,37,91,35,"length"],[82,43,91,41],[82,46,91,44],[82,47,91,45],[83,4,92,2],[85,4,94,2],[86,0,95,0],[87,0,96,0],[88,4,97,2,"processNext"],[88,15,97,13,"processNext"],[88,16,97,13],[88,18,97,22],[89,6,98,4],[89,12,98,10,"queue"],[89,17,98,15],[89,20,98,18],[89,24,98,22],[89,25,98,23,"_getCurrentQueue"],[89,41,98,39],[89,42,98,40],[89,43,98,41],[90,6,99,4],[90,10,99,8,"queue"],[90,15,99,13],[90,16,99,14,"length"],[90,22,99,20],[90,24,99,22],[91,8,100,6],[91,14,100,12,"task"],[91,18,100,16],[91,21,100,19,"queue"],[91,26,100,24],[91,27,100,25,"shift"],[91,32,100,30],[91,33,100,31],[91,34,100,32],[92,8,101,6],[92,12,101,10],[93,10,102,8],[93,14,102,12],[93,21,102,19,"task"],[93,25,102,23],[93,30,102,28],[93,38,102,36],[93,42,102,40,"task"],[93,46,102,44],[93,47,102,45,"gen"],[93,50,102,48],[93,52,102,50],[94,12,103,10,"DEBUG"],[94,17,103,15],[94,21,103,19,"infoLog"],[94,28,103,26],[94,29,103,27],[94,62,103,60],[94,65,103,63,"task"],[94,69,103,67],[94,70,103,68,"name"],[94,74,103,72],[94,75,103,73],[95,12,104,10],[95,16,104,14],[95,17,104,15,"_genPromise"],[95,28,104,26],[95,29,104,27,"task"],[95,33,104,31],[95,34,104,32],[96,10,105,8],[96,11,105,9],[96,17,105,15],[96,21,105,19],[96,28,105,26,"task"],[96,32,105,30],[96,37,105,35],[96,45,105,43],[96,49,105,47,"task"],[96,53,105,51],[96,54,105,52,"run"],[96,57,105,55],[96,59,105,57],[97,12,106,10,"DEBUG"],[97,17,106,15],[97,21,106,19,"infoLog"],[97,28,106,26],[97,29,106,27],[97,51,106,49],[97,54,106,52,"task"],[97,58,106,56],[97,59,106,57,"name"],[97,63,106,61],[97,64,106,62],[98,12,107,10,"task"],[98,16,107,14],[98,17,107,15,"run"],[98,20,107,18],[98,21,107,19],[98,22,107,20],[99,10,108,8],[99,11,108,9],[99,17,108,15],[100,12,109,10,"invariant"],[100,21,109,19],[100,22,110,12],[100,29,110,19,"task"],[100,33,110,23],[100,38,110,28],[100,48,110,38],[100,50,111,12],[100,109,111,71],[100,112,112,14,"JSON"],[100,116,112,18],[100,117,112,19,"stringify"],[100,126,112,28],[100,127,112,29,"task"],[100,131,112,33],[100,133,112,35],[100,137,112,39],[100,139,112,41],[100,140,112,42],[100,141,113,10],[100,142,113,11],[101,12,114,10,"DEBUG"],[101,17,114,15],[101,21,114,19,"infoLog"],[101,28,114,26],[101,29,114,27],[101,60,114,58],[101,61,114,59],[102,12,115,10,"task"],[102,16,115,14],[102,17,115,15],[102,18,115,16],[103,10,116,8],[104,8,117,6],[104,9,117,7],[104,10,117,8],[104,17,117,15,"e"],[104,18,117,16],[104,20,117,18],[105,10,118,8,"e"],[105,11,118,9],[105,12,118,10,"message"],[105,19,118,17],[105,22,119,10],[105,51,119,39],[105,55,119,43,"task"],[105,59,119,47],[105,60,119,48,"name"],[105,64,119,52],[105,68,119,56],[105,70,119,58],[105,71,119,59],[105,74,119,62],[105,78,119,66],[105,81,119,69,"e"],[105,82,119,70],[105,83,119,71,"message"],[105,90,119,78],[106,10,120,8],[106,16,120,14,"e"],[106,17,120,15],[107,8,121,6],[108,6,122,4],[109,4,123,2],[110,4,132,2,"_getCurrentQueue"],[110,20,132,18,"_getCurrentQueue"],[110,21,132,18],[110,23,132,34],[111,6,133,4],[111,12,133,10,"stackIdx"],[111,20,133,18],[111,23,133,21],[111,27,133,25],[111,28,133,26,"_queueStack"],[111,39,133,37],[111,40,133,38,"length"],[111,46,133,44],[111,49,133,47],[111,50,133,48],[112,6,134,4],[112,12,134,10,"queue"],[112,17,134,15],[112,20,134,18],[112,24,134,22],[112,25,134,23,"_queueStack"],[112,36,134,34],[112,37,134,35,"stackIdx"],[112,45,134,43],[112,46,134,44],[113,6,135,4],[113,10,136,6,"queue"],[113,15,136,11],[113,16,136,12,"popable"],[113,23,136,19],[113,27,137,6,"queue"],[113,32,137,11],[113,33,137,12,"tasks"],[113,38,137,17],[113,39,137,18,"length"],[113,45,137,24],[113,50,137,29],[113,51,137,30],[113,55,138,6],[113,59,138,10],[113,60,138,11,"_queueStack"],[113,71,138,22],[113,72,138,23,"length"],[113,78,138,29],[113,81,138,32],[113,82,138,33],[113,84,139,6],[114,8,140,6],[114,12,140,10],[114,13,140,11,"_queueStack"],[114,24,140,22],[114,25,140,23,"pop"],[114,28,140,26],[114,29,140,27],[114,30,140,28],[115,8,141,6,"DEBUG"],[115,13,141,11],[115,17,142,8,"infoLog"],[115,24,142,15],[115,25,142,16],[115,52,142,43],[115,54,142,45],[116,10,143,10,"stackIdx"],[116,18,143,18],[117,10,144,10,"queueStackSize"],[117,24,144,24],[117,26,144,26],[117,30,144,30],[117,31,144,31,"_queueStack"],[117,42,144,42],[117,43,144,43,"length"],[118,8,145,8],[118,9,145,9],[118,10,145,10],[119,8,146,6],[119,15,146,13],[119,19,146,17],[119,20,146,18,"_getCurrentQueue"],[119,36,146,34],[119,37,146,35],[119,38,146,36],[120,6,147,4],[120,7,147,5],[120,13,147,11],[121,8,148,6],[121,15,148,13,"queue"],[121,20,148,18],[121,21,148,19,"tasks"],[121,26,148,24],[122,6,149,4],[123,4,150,2],[124,4,152,2,"_genPromise"],[124,15,152,13,"_genPromise"],[124,16,152,14,"task"],[124,20,152,31],[124,22,152,33],[125,6,153,4],[126,6,154,4],[127,6,155,4],[128,6,156,4],[129,6,157,4],[129,10,157,8],[129,11,157,9,"_queueStack"],[129,22,157,20],[129,23,157,21,"push"],[129,27,157,25],[129,28,157,26],[130,8,157,27,"tasks"],[130,13,157,32],[130,15,157,34],[130,17,157,36],[131,8,157,38,"popable"],[131,15,157,45],[131,17,157,47],[132,6,157,52],[132,7,157,53],[132,8,157,54],[133,6,158,4],[133,12,158,10,"stackIdx"],[133,20,158,18],[133,23,158,21],[133,27,158,25],[133,28,158,26,"_queueStack"],[133,39,158,37],[133,40,158,38,"length"],[133,46,158,44],[133,49,158,47],[133,50,158,48],[134,6,159,4],[134,12,159,10,"stackItem"],[134,21,159,19],[134,24,159,22],[134,28,159,26],[134,29,159,27,"_queueStack"],[134,40,159,38],[134,41,159,39,"stackIdx"],[134,49,159,47],[134,50,159,48],[135,6,160,4,"DEBUG"],[135,11,160,9],[135,15,160,13,"infoLog"],[135,22,160,20],[135,23,160,21],[135,52,160,50],[135,54,160,52],[136,8,160,53,"stackIdx"],[137,6,160,61],[137,7,160,62],[137,8,160,63],[138,6,161,4,"DEBUG"],[138,11,161,9],[138,15,161,13,"infoLog"],[138,22,161,20],[138,23,161,21],[138,50,161,48],[138,53,161,51,"task"],[138,57,161,55],[138,58,161,56,"name"],[138,62,161,60],[138,63,161,61],[139,6,162,4,"task"],[139,10,162,8],[139,11,163,7,"gen"],[139,14,163,10],[139,15,163,11],[139,16,163,12],[139,17,164,7,"then"],[139,21,164,11],[139,22,164,12],[139,28,164,18],[140,8,165,8,"DEBUG"],[140,13,165,13],[140,17,166,10,"infoLog"],[140,24,166,17],[140,25,166,18],[140,58,166,51],[140,61,166,54,"task"],[140,65,166,58],[140,66,166,59,"name"],[140,70,166,63],[140,72,166,65],[141,10,167,12,"stackIdx"],[141,18,167,20],[142,10,168,12,"queueStackSize"],[142,24,168,26],[142,26,168,28],[142,30,168,32],[142,31,168,33,"_queueStack"],[142,42,168,44],[142,43,168,45,"length"],[143,8,169,10],[143,9,169,11],[143,10,169,12],[144,8,170,8,"stackItem"],[144,17,170,17],[144,18,170,18,"popable"],[144,25,170,25],[144,28,170,28],[144,32,170,32],[145,8,171,8],[145,12,171,12],[145,13,171,13,"hasTasksToProcess"],[145,30,171,30],[145,31,171,31],[145,32,171,32],[145,36,171,36],[145,40,171,40],[145,41,171,41,"_onMoreTasks"],[145,53,171,53],[145,54,171,54],[145,55,171,55],[146,6,172,6],[146,7,172,7],[146,8,172,8],[146,9,173,7,"catch"],[146,14,173,12],[146,15,173,13,"ex"],[146,17,173,15],[146,21,173,19],[147,8,174,8,"setTimeout"],[147,18,174,18],[147,19,174,19],[147,25,174,25],[148,10,175,10,"ex"],[148,12,175,12],[148,13,175,13,"message"],[148,20,175,20],[148,23,175,23],[148,69,175,69,"task"],[148,73,175,73],[148,74,175,74,"name"],[148,78,175,78],[148,83,175,83,"ex"],[148,85,175,85],[148,86,175,86,"message"],[148,93,175,93],[148,95,175,95],[149,10,176,10],[149,16,176,16,"ex"],[149,18,176,18],[150,8,177,8],[150,9,177,9],[150,11,177,11],[150,12,177,12],[150,13,177,13],[151,6,178,6],[151,7,178,7],[151,8,178,8],[152,4,179,2],[153,2,180,0],[154,2,182,0,"module"],[154,8,182,6],[154,9,182,7,"exports"],[154,16,182,14],[154,19,182,17,"TaskQueue"],[154,28,182,26],[155,0,182,27]],"functionMap":{"names":["<global>","TaskQueue","constructor","enqueue","enqueueTasks","tasks.forEach$argument_0","cancelTasks","_queueStack.map$argument_0","queue.tasks.filter$argument_0","_queueStack.map.filter$argument_0","hasTasksToProcess","processNext","_getCurrentQueue","_genPromise","task.gen.then$argument_0","task.gen.then._catch$argument_0","setTimeout$argument_0"],"mappings":"AAA;AC2C;ECQ;GDG;EEO;GFE;EGE;kBCC,0BD;GHC;EKE;WCG;kCCE,0CD;QDC;cGC,mDH;GLC;ESY;GTE;EUK;GV0B;EWS;GXkB;EYE;YCY;ODQ;aEC;mBCC;SDG;OFC;GZC;CDC"}},"type":"js/module"}]}